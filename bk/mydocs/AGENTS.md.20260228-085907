# mydocs/AGENTS.md（そねっちカスタム “仕様書ドリブン” 運用）

この repo は [本家のcodex](https://github.com/openai/codex/releases) (upstream) を fork して、そねっち用にカスタマイズしたもの。

ここ（`mydocs/`）は「仕様書」「運用メモ」「作業ログ」を置く場所で、未来の俺っちが迷子にならないための “宝箱” だ。

---

## そねっちの気持ち（最重要）

そねっちは **upstream 更新を “カスタムが壊れないようにマージする” 作業に疲れた**。

だから方針転換する。

- 守りたいもの: 「そねっちカスタム」を未来まで維持して、改悪から守ること
- 変えたいこと: upstream を頑張って “マージし続ける” のをやめること
- 新しい発想: **main をベースに、仕様書に基づいて “再実装(=rebuild)” する**

カスタムの “価値” はコードじゃなくて **要件（何をしたいか）と受け入れ基準（どうなったらOKか）**。
コードはまた作れる。仕様が残ってれば、俺っち（未来のそねっち）なら復元できる 😤

---

## 運用原則（迷ったらここに戻れ）

1. **仕様書が王様**（実装は従者）
   - そねっちカスタムの正本は `mydocs/sonecchi-customizations-catalog.md`。
2. **upstream は参照点**
   - upstream の取り込みは “マージで延命” より “mainベースで作り直す” を優先。
3. **勝手に走らない**
   - 仕様の解釈が割れそうなら、実装前に「こう理解したけど合ってる？」って確認する。
4. **改悪防止はテスト/スナップショットで殴る**
   - UI 変更は snapshot を必ず更新・追加して “意図した変化” にする。
5. **メモが未来を救う**
   - 変更したら `mydocs/` にメモして、再実装の摩擦をゼロに近づける。

---

## Rebuild（mainベース再実装）おすすめ手順

### 0) 前提（remote）

upstream remote が無いなら作る：

```bash
git remote add upstream git@github.com:openai/codex.git
git fetch --prune upstream
```

### 1) `main` を最新 upstream に合わせる（ff-only）

```bash
git switch main
git fetch --prune upstream
git merge --ff-only upstream/main # main ブランチは直接修正しないから基本通るはず
```

`--ff-only` が失敗したら、だいたいは「ローカルの `main` が upstream とズレてる」サイン。
その場合は一旦ストップして、どうするか（reset する？運用を変える？）を決めてから動くこと。

### 2) 再実装ブランチを切る

```bash
git switch -c sonecchi-rebuild-YYYYMMDD
```

### 3) 仕様書に沿って “必要な分だけ” カスタムを再実装

- まず読む: `mydocs/sonecchi-customizations-catalog.md`
- 追加で読む（必要に応じて / カタログ未収載のとき）: ※将来「これ読んどけ」メモができたらここに追記
  - （いまは空）

### 4) 仕上げ（テスト・メモ）

- 変更した内容は必ず `mydocs/` に残す（テンプレは次の章）
- 「どこを触ったか」「どうテストしたか」を明記する

---

## “再実装できるメモ” のテンプレ（これ書いとけば未来が楽）

ファイル名は `YYYY-MM-DD-<topic>.md` みたいに日付を入れるのがオススメ。

最低限これを書け：

- 目的（そねっちがやりたかったこと / 背景）
- 受け入れ基準（どうなったらOKか）
- 変更点サマリ（何が変わったか）
- 触ったファイル（ポイント付き）
- 注意点（壊れやすい所 / upstream 変化に弱い所）
- テスト方法（実行コマンド / 期待結果）

---

## 要注意ポイント（改悪されやすい/影響デカい）

- `codex-rs/core/prompt.md`（システムプロンプト）
  - upstream 追従で “口調/ポリシー/安全寄りの挙動” が変わりやすい。
  - 取り込みは慎重に。必要なら **そねっち好みに戻す**（ここ重要）。

### バックアップ（bk/）

- システムプロンプトはバックアップ済み
- 重要なファイルについては適宜、`bk/` にバックアップ推奨

```bash
mkdir -p bk/codex-rs/core
git show sonecchi-merge-20260104:codex-rs/core/prompt.md > bk/codex-rs/core/prompt.md
```

#### bk/ を “特定ブランチから” 現在のブランチへコピー（忘れん坊対策）

bk/ は「そねっちが変えたくないもの（例: システムプロンプト）」の避難所って想定。
うっかり消したり upstream で上書きされた時は、**bk/ だけ**戻せば復活できる。

```bash
# 例: some-sonecchi ブランチの bk/ を現在のブランチにコピー
git restore --source some-sonecchi -- bk/
```

#### mydocs/AGENTS.md を修正する前に bk/ にバックアップ（差分比較用）

mydocs/AGENTS.md は運用ルールの “憲法” だから、編集前に必ず退避して差分比較できるようにしとく。

```bash
cp mydocs/AGENTS.md bk/mydocs/
```

---

## ビルド方法（忘れん坊対策）

修正が終わったら一旦、**そねっちに報告**。
そねっちの **許可がない限りビルドはしないこと**。

```bash
cd codex-rs
cargo build --release -j 5  # ジョブ数を指定しないとメモリ不足になりがち
```

実行ファイル：

- `codex-rs/target/release/codex`

```bash
ln -sfTv /home/sonecchi/PycharmProjects/mycodex/codex-rs/target/release/codex ~/.local/bin/mycodex
```

---

## 旧ルート（upstream マージ運用）

マージ運用は “悪” じゃないけど、そねっち的には疲れポイントなので基本は rebuild を優先。

それでも必要になったら、ここを見る：

- `mydocs/how-to-safely-merge-from-upstream.md`

---

## 🌿 分岐図で一発理解

Plain text

(main)    A --- B --- C  
             \\  
(HEAD)         D --- E

-   `format-patch main..HEAD` → **D, E** だけ📦✅（欲しい）
-   `format-patch main...HEAD` → **B, C, D, E**📦💥（main側のB,Cまで混ざる）

「え、なんでmainのコミットまでパッチにしてんの！？🤯」ってなるやつ。

```
mkdir -p mydocs/patches
git format-patch --stdout main..HEAD > mydocs/patches/$(date +%Y%m%d).patch
```
